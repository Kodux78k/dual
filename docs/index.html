<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Dual Mobile Mockup v0.3 ‚Äî UNO ‚Üí DUAL ‚Üí TRINITY (Ba√∫, Menu, M√≥dulos)</title>
<meta name="theme-color" content="#0b0f17" />
<style>
  :root{
    --bg:#0b0f17;--panel:#0f1522;--glass:rgba(255,255,255,.06);--line:rgba(255,255,255,.14);
    --ink:#e9f6ff;--muted:#97b1c6;--accent:#29d3ff;--accent2:#ff5af4;--ok:#39ffb6;--warn:#ffb74d;--err:#ff5a6e;
    --rad:18px;--pad:14px;--shadow:0 12px 40px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.04);
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    color:var(--ink);
    background:radial-gradient(1200px 800px at 20% -10%, rgba(41,211,255,.1) 0%, var(--bg) 55%, var(--bg) 100%);
    overflow-x:hidden;
    display:flex;flex-direction:column;
  }
  /* UTILS */
  .mut{color:var(--muted)}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .err{color:var(--err)}
  .glass{background:var(--glass);backdrop-filter:blur(12px) saturate(150%);border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow);}
  .line{border-top:1px solid var(--line);margin:var(--pad) 0;}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;
    padding:8px 16px;border-radius:12px;cursor:pointer;
    background:var(--panel);border:1px solid var(--line);
    transition:background .2s, border-color .2s;
  }
  .btn:hover{background:rgba(255,255,255,.1);border-color:var(--accent)}
  .btn:active{background:rgba(255,255,255,.15)}
  .btn.accent{background:var(--accent);color:var(--bg);font-weight:600;border-color:var(--accent)}
  .btn.accent:hover{background:var(--accent2);border-color:var(--accent2)}
  .btn-icon{width:36px;height:36px;padding:0;border-radius:50%;}

  /* LAYOUT */
  #console{
    position:fixed;bottom:0;left:0;right:0;height:0;
    background:rgba(0,0,0,.9);border-top:1px solid var(--accent);
    color:var(--ok);font-size:12px;padding:0 var(--pad);overflow:auto;
    transition:height .3s cubic-bezier(0.25, 0.46, 0.45, 0.94);z-index:1000;
  }
  #console.show{height:200px}
  #hud{
    display:flex;justify-content:space-between;align-items:center;
    padding:var(--pad) 16px;z-index:20;
    background:rgba(0,0,0,.2);border-bottom:1px solid var(--line);
  }
  #brain{
    flex:1;padding:16px;display:flex;flex-direction:column;gap:16px;
    overflow-y:auto;
  }

  /* PANEL GERAL */
  .panel{
    display:flex;flex-direction:column;
    padding:var(--pad);
    background:var(--panel);border:1px solid var(--line);border-radius:var(--rad);
    box-shadow:0 8px 24px rgba(0,0,0,.4);
  }
  .panel-header{
    display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;
    font-size:1.1em;font-weight:600;
  }
  .panel-body{
    flex:1;font-size:13px;
  }

  /* MODULE SPECIFICS */
  #panel-core-storage .status-grid{
    display:grid;grid-template-columns:auto 1fr;gap:6px 10px;
  }

  /* MENU ESTOJO */
  #menuEstojo{
    position:fixed;top:60px;right:16px;
    width:300px;max-width:calc(100% - 32px);
    background:var(--panel);border:1px solid var(--accent);
    border-radius:var(--rad);
    padding:var(--pad);
    z-index:50;
    transform:scale(.95);opacity:0;pointer-events:none;
    transition:transform .2s, opacity .2s;
  }
  #menuEstojo.show{transform:scale(1);opacity:1;pointer-events:auto;}
  .module-item{
    display:flex;justify-content:space-between;align-items:center;
    padding:8px 0;
  }
  .module-item:not(:last-child){border-bottom:1px solid rgba(255,255,255,.08);}

  /* TOGGLE SWITCH - CSS from scratch for aesthetics */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
    cursor: pointer;
  }
  .toggle-switch input {opacity: 0; width: 0; height: 0;}
  .slider {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--line);
    transition: .4s;
    border-radius: 12px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: var(--ink);
    transition: .4s;
    border-radius: 50%;
  }
  input:checked + .slider {background-color: var(--accent);}
  input:checked + .slider:before {
    transform: translateX(20px);
    background-color: var(--bg);
  }

  /* TOAST */
  #toast{
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,.8);color:var(--ok);padding:10px 20px;border-radius:10px;
    border:1px solid var(--ok);box-shadow:0 4px 12px rgba(0,0,0,.5);
    opacity:0;pointer-events:none;transition:opacity .3s;z-index:999;
  }
  #toast.show{opacity:1;}
</style>
<!-- Firebase Imports -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Vari√°veis globais obrigat√≥rias do ambiente Canvas
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-dual-app-id';
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Objeto de estado global
  window.S = {
    // Estado do sistema e UI
    authReady: false,
    firestoreStatus: 'Desconectado',
    userId: null,
    consoleOpen: false,
    estojoOpen: false,

    // Configura√ß√£o persistente (com valores iniciais para fallback)
    config: JSON.parse(localStorage.getItem('S.config') || JSON.stringify({
      lastSave: 0,
      lastLoad: 0,
      modules: {
        'core.storage': { active: true, name: 'Ba√∫ (Config)', icon: 'üì¶' },
        'net.ping': { active: true, name: 'Rede & Ping', icon: 'üì∂' },
        'sec.keys': { active: false, name: 'Chaves SK', icon: 'üîë' },
        'app.dual': { active: true, name: 'Dual App (Placeholder)', icon: 'üì∫' },
      },
      packs: {},
    })),
    
    // Lista de m√≥dulos para itera√ß√£o
    modules: ['core.storage', 'net.ping', 'sec.keys', 'app.dual'],
    
    // Inst√¢ncias Firebase
    app: null,
    db: null,
    auth: null,
  };

  setLogLevel('Debug'); // Habilita logs para depura√ß√£o

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Armazena as inst√¢ncias no estado global
  S.app = app;
  S.db = db;
  S.auth = auth;

  // --- Helpers Firestore ---
  const getConfigDocRef = (db, userId, appId) => {
    // Caminho privado: /artifacts/{appId}/users/{userId}/dual_config/main
    return doc(db, `artifacts/${appId}/users/${userId}/dual_config/main`);
  };

  /** Salva S.config no Firestore */
  window.saveConfigToFirestore = async () => {
    if (!S.authReady || !S.userId) return console.warn('Auth n√£o est√° pronta para salvar.');
    
    // Atualiza o timestamp antes de salvar
    S.config.lastSave = Date.now();
    const configToSave = JSON.parse(JSON.stringify(S.config)); // Clonar para garantir que √© um objeto limpo

    try {
      const docRef = getConfigDocRef(S.db, S.userId, appId);
      await setDoc(docRef, { config: configToSave }, { merge: true });
      localStorage.setItem('S.config', JSON.stringify(S.config)); // Backup local
      
      console.log('Configura√ß√£o salva no Firestore e localStorage.');
      renderConfigPanel();
    } catch (e) {
      console.error('Erro ao salvar no Firestore:', e);
      S.firestoreStatus = 'ERRO';
      renderConfigPanel();
    }
  };

  /** Configura o listener em tempo real (onSnapshot) */
  const setupConfigListener = (userId) => {
    const docRef = getConfigDocRef(S.db, userId, appId);
    
    onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists() && docSnap.data().config) {
        const firestoreConfig = docSnap.data().config;
        
        // Carrega a config do Firestore
        S.config = {
          ...S.config, // Preserva quaisquer outras chaves que n√£o sejam do Firestore
          ...firestoreConfig,
          lastLoad: Date.now(),
        };

        // Verifica se o m√≥dulo de storage est√° ativo e o renderiza (Importante!)
        if (!S.config.modules || !S.config.modules['core.storage']) {
             S.config.modules = S.config.modules || {};
             S.config.modules['core.storage'] = S.config.modules['core.storage'] || { active: true, name: 'Ba√∫ (Config)', icon: 'üì¶' };
        }

        S.firestoreStatus = 'Conectado';
        localStorage.setItem('S.config', JSON.stringify(S.config));
        
        console.log('Configura√ß√£o carregada do Firestore.');
        renderBrain(); // Renderiza todo o HUD/Pain√©is
        renderEstojo(); // Renderiza o menu de m√≥dulos
      } else {
        S.firestoreStatus = 'Novo';
        console.log('Documento de configura√ß√£o n√£o existe. Usando config local/padr√£o.');
        // Se o documento n√£o existe, tenta salvar a config local/padr√£o para inicializar
        saveConfigToFirestore();
      }
      renderConfigPanel(); // Garante que o painel de status seja atualizado
    }, (error) => {
      console.error('Erro no listener do Firestore:', error);
      S.firestoreStatus = 'ERRO';
      renderConfigPanel();
    });
  };

  // --- Autentica√ß√£o ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      S.userId = user.uid;
      S.authReady = true;
      console.log('Usu√°rio autenticado:', S.userId);
      setupConfigListener(S.userId);
    } else {
      S.authReady = true;
      S.userId = 'anon_' + crypto.randomUUID(); // Fallback para ID an√¥nimo (mas sem Firestore)
      S.firestoreStatus = 'Local (Sem Login)';
      console.warn('Usu√°rio n√£o autenticado. Usando ID an√¥nimo.');
      renderBrain();
      renderConfigPanel();
    }
  });

  // Tenta logar com o token personalizado ou anonimamente
  async function signIn() {
    try {
      // 1. Persist√™ncia local (para o token de sess√£o)
      await setPersistence(auth, browserLocalPersistence);

      if (initialAuthToken) {
        await signInWithCustomToken(auth, initialAuthToken);
        console.log('Login com token customizado.');
      } else {
        await signInAnonymously(auth);
        console.log('Login an√¥nimo.');
      }
    } catch (error) {
      console.error('Erro de autentica√ß√£o Firebase:', error);
      // Se a autentica√ß√£o falhar, onAuthStateChanged ainda ser√° chamado sem um usu√°rio
    }
  }

  // Inicializa o login
  window.addEventListener('load', signIn);

</script>

<script>
  // --- Fun√ß√µes de UI & Core ---

  /** Helper para buscar elementos */
  const $ = (s) => document.querySelector(s);

  /** Mostra um toast de notifica√ß√£o */
  function toast(msg, type = 'ok') {
    const t = $('#toast');
    t.textContent = msg;
    t.className = type === 'ok' ? 'show' : `show ${type}`;
    setTimeout(() => t.className = '', 3000);
  }

  /** Renderiza o console (existente) */
  function renderConsole() {
    $('#console').innerHTML = S.consoleOpen ? 'Logs (somente para refer√™ncia):<br>' + console.logs.slice(-10).join('<br>') : '';
  }

  // Sobrescreve console.log para capturar logs
  (function() {
      const originalLog = console.log;
      const originalWarn = console.warn;
      const originalError = console.error;
      console.logs = [];

      function customLog(type, ...args) {
          const msg = `[${new Date().toLocaleTimeString('pt-BR')}] [${type.toUpperCase()}] ${args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ')}`;
          console.logs.push(`<span class="${type === 'error' ? 'err' : type === 'warn' ? 'warn' : 'ok'}">${msg}</span>`);
          if (S.consoleOpen) renderConsole();
          
          if (type === 'log') originalLog.apply(console, args);
          if (type === 'warn') originalWarn.apply(console, args);
          if (type === 'error') originalError.apply(console, args);
      }

      console.log = (...args) => customLog('log', ...args);
      console.warn = (...args) => customLog('warn', ...args);
      console.error = (...args) => customLog('error', ...args);
  })();


  /**
   * --- FUN√á√ïES DE RENDERIZA√á√ÉO DE PAIN√âIS ---
   */

  /** Renderiza o painel de core.storage (Ba√∫) */
  function renderConfigPanel() {
    const panel = $('#panel-core-storage .panel-body');
    if (!panel) return;
    
    const config = S.config;
    const localConfig = localStorage.getItem('S.config');
    const localSize = localConfig ? (new TextEncoder().encode(localConfig).length / 1024).toFixed(2) : '0.00';
    
    const lastSave = config.lastSave ? new Date(config.lastSave).toLocaleString('pt-BR') : 'Nunca';
    const lastLoad = config.lastLoad ? new Date(config.lastLoad).toLocaleString('pt-BR') : 'Padr√£o';

    let statusClass = 'mut';
    if (S.firestoreStatus === 'Conectado') statusClass = 'ok';
    if (S.firestoreStatus === 'ERRO') statusClass = 'err';
    if (S.firestoreStatus === 'Novo') statusClass = 'warn';

    panel.innerHTML = `
      <div class="status-grid">
        <span class="mut">ID de Usu√°rio:</span> <span>${S.userId || 'Desconhecido'}</span>
        <span class="mut">Status Firestore:</span> <span class="${statusClass}">${S.firestoreStatus}</span>
        <span class="mut">√öltimo Salvamento:</span> <span>${lastSave}</span>
        <span class="mut">√öltimo Carregamento:</span> <span>${lastLoad}</span>
      </div>
      <div class="line"></div>
      <p class="mut" style="margin-top:0">Configura√ß√£o Local (Backup)</p>
      <div class="status-grid">
        <span class="mut">Tamanho (KB):</span> <span>${localSize} KB</span>
        <span class="mut">Vers√£o Local:</span> <span>${localConfig ? 'Presente' : 'Vazio'}</span>
      </div>
      <div style="display:flex;gap:10px;margin-top:14px;">
        <button id="btnSaveConfig" class="btn">Salvar Manual</button>
        <button id="btnExportConfig" class="btn">Exportar</button>
        <input type="file" id="inputImportConfig" accept=".json" style="display:none;">
        <button id="btnImportConfig" class="btn accent">Importar</button>
      </div>
    `;

    // Adiciona event listeners
    $('#btnSaveConfig').onclick = async () => {
      await saveConfigToFirestore();
      toast('Configura√ß√£o salva!');
    };
    $('#btnExportConfig').onclick = exportConfig;
    $('#btnImportConfig').onclick = () => $('#inputImportConfig').click();
    $('#inputImportConfig').onchange = importConfig;
  }

  /** L√≥gica de Exporta√ß√£o de S.config */
  function exportConfig() {
    const configString = JSON.stringify(S.config, null, 2);
    const blob = new Blob([configString], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `dual_config_export_${Date.now()}.json`;
    a.click();
    toast('Configura√ß√£o exportada com sucesso!');
  }

  /** L√≥gica de Importa√ß√£o de S.config */
  function importConfig(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const importedConfig = JSON.parse(e.target.result);
        if (importedConfig.modules) {
            
          // Merge: Preserva configura√ß√µes existentes e aplica as novas
          S.config = {
              ...S.config,
              ...importedConfig,
              modules: {
                  ...S.config.modules,
                  ...importedConfig.modules,
              }
          };
          
          await saveConfigToFirestore();
          toast('Configura√ß√£o importada e salva no Firestore!');
        } else {
          toast('Arquivo JSON inv√°lido (Falta chave "modules")', 'err');
        }
      } catch (error) {
        toast('Erro ao ler ou parsear o arquivo JSON.', 'err');
        console.error('Erro de importa√ß√£o:', error);
      }
    };
    reader.readAsText(file);
    event.target.value = ''; // Limpa o input
  }


  /** Renderiza o menu de m√≥dulos (Estojo) */
  function renderEstojo() {
    const estojo = $('#menuEstojo');
    estojo.classList.toggle('show', S.estojoOpen);
    if (!S.estojoOpen) return;

    const moduleList = estojo.querySelector('.panel-body');
    if (!moduleList) return;

    let html = '';
    S.modules.forEach(key => {
      const mod = S.config.modules[key] || { active: false, name: key, icon: '?' };
      const isChecked = mod.active ? 'checked' : '';

      html += `
        <div class="module-item">
          <div>${mod.icon} ${mod.name}</div>
          <label class="toggle-switch">
            <input type="checkbox" data-module="${key}" ${isChecked}>
            <span class="slider"></span>
          </label>
        </div>
      `;
    });

    moduleList.innerHTML = html;

    // Adiciona listeners para os toggles
    moduleList.querySelectorAll('input[type="checkbox"]').forEach(input => {
      input.onchange = (e) => {
        const moduleName = e.target.dataset.module;
        const isActive = e.target.checked;
        
        S.config.modules[moduleName].active = isActive;
        saveConfigToFirestore();
        renderBrain(); // Atualiza a exibi√ß√£o dos pain√©is
        toast(isActive ? `${moduleName} ativado.` : `${moduleName} desativado.`, 'ok');
      };
    });
  }

  /** Renderiza o HUD e todos os pain√©is vis√≠veis */
  function renderBrain() {
    // 1. Renderiza o HUD (usu√°rio/status)
    const hudInfo = S.userId ? `<span class="mut">${S.firestoreStatus} | ${S.userId.substring(0, 8)}...</span>` : '<span class="warn">Desconectado</span>';
    $('#hud-info').innerHTML = hudInfo;

    // 2. Renderiza o conte√∫do do #brain
    const brain = $('#brain');
    
    // Mapeamento dos pain√©is
    const panelRenderers = {
      'core.storage': renderConfigPanel,
      'net.ping': () => $('#panel-net-ping .panel-body').innerHTML = `
        <p class="mut">M√≥dulo para monitoramento de rede e ping.</p>
        <p>Aguardando implementa√ß√£o da l√≥gica de rede...</p>
      `,
      'sec.keys': () => $('#panel-sec-keys .panel-body').innerHTML = `
        <p class="mut">M√≥dulo para gerenciamento de chaves secretas (SK) e APIs.</p>
        <p>Ainda sem chaves definidas. Status: Offline.</p>
      `,
      'app.dual': () => $('#panel-app-dual .panel-body').innerHTML = `
        <p class="mut">Conte√∫do principal do seu Organismo Dual.</p>
        <h3 style="margin:0;">Bem-vindo, Operador!</h3>
        <div class="line"></div>
        <p>Este √© o ponto de partida para suas aplica√ß√µes. Use o **Estojo (Orbe)** para gerenciar o que voc√™ v√™.</p>
      `,
    };

    // Gera o HTML de todos os pain√©is
    let allPanelsHtml = S.modules.map(moduleName => {
      const mod = S.config.modules[moduleName] || { active: false, name: moduleName, icon: '?' };
      const isActive = mod.active;

      return `
        <div id="panel-${moduleName.replace('.', '-')}" class="panel" style="display: ${isActive ? 'flex' : 'none'};">
          <div class="panel-header">
            <span>${mod.icon} ${mod.name}</span>
            <span class="mut">${moduleName}</span>
          </div>
          <div class="panel-body">
            <!-- Conte√∫do ser√° injetado pelo renderizador espec√≠fico -->
          </div>
        </div>
      `;
    }).join('');

    // Atualiza o container do c√©rebro
    if (brain.innerHTML !== allPanelsHtml) {
        brain.innerHTML = allPanelsHtml;
    }


    // 3. Executa os renderizadores para preencher o conte√∫do din√¢mico
    S.modules.forEach(moduleName => {
      const mod = S.config.modules[moduleName];
      if (mod && mod.active && panelRenderers[moduleName]) {
        panelRenderers[moduleName]();
      }
    });
  }

  // --- Eventos da Aplica√ß√£o ---

  function toggleConsole(){ 
    S.consoleOpen=!S.consoleOpen; 
    $('#console').classList.toggle('show', S.consoleOpen); 
    renderConsole(); 
  }

  function toggleEstojo(){
    S.estojoOpen = !S.estojoOpen;
    renderEstojo();
  }

  // Bindings iniciais
  window.onload = () => {
    $('#btnConsole').onclick = toggleConsole;
    $('#btnOrbe').onclick = toggleEstojo;

    // O renderBrain √© chamado ap√≥s o listener do Firestore carregar a configura√ß√£o
    // Mas chamamos ele aqui para renderizar o esqueleto inicial e HUD
    renderBrain();
  };
</script>

</head>
<body>

<!-- HUD: Cabe√ßalho -->
<header id="hud">
  <div style="font-size:1.4em;font-weight:700;">UNO ‚Ä¢ TRINITY</div>
  <div id="hud-info" class="mut">Carregando Auth...</div>
  <div style="display:flex;gap:8px;">
    <button id="btnConsole" class="btn btn-icon">
      <span style="font-size:1.2em;">&gt;_</span>
    </button>
    <button id="btnOrbe" class="btn btn-icon accent" title="Estojo / Menu de M√≥dulos">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path><path d="M2 12h20"></path></svg>
    </button>
  </div>
</header>

<!-- BRAIN: Container principal dos pain√©is -->
<main id="brain">
  <!-- Os pain√©is dos m√≥dulos ser√£o inseridos aqui por renderBrain() -->
</main>

<!-- CONSOLE: Log de debug -->
<div id="console"></div>

<!-- TOAST: Notifica√ß√µes -->
<div id="toast"></div>

<!-- MENU ESTOJO: Menu flutuante para gerenciar m√≥dulos -->
<div id="menuEstojo" class="glass">
  <div class="panel-header">
    <span>üíé Estojo/Menu</span>
    <button class="btn btn-icon" style="background:transparent;border:none;" onclick="toggleEstojo()">
        <span style="font-size:1.2em;">‚úï</span>
    </button>
  </div>
  <div class="panel-body">
    <!-- Lista de m√≥dulos ser√° injetada por renderEstojo() -->
    Carregando m√≥dulos...
  </div>
</div>

</body>
</html>

