<!DOCTYPE html>
<!-- Dual Atom v12 FINAL build — 2025-10-06 01:53:58Z — source: Dual_Atom_v12r7_fused_patched.html -->
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Dual Atom v12 — Final</title>
<meta name="theme-color" content="#0a0b10">
<style>
  /* =================== MOBILE-FIRST VERTICAL HARD-LOCK =================== */
  :root{
    --bg0:#07080d; --bg1:#0d1020;
    --nebA:#7a3cff; --nebB:#00e5ff;
    --txt:#eaf2ff; --muted:#a6b0c0;
    --ring:rgba(255,255,255,.16);
    --glass:rgba(255,255,255,.06);
    --blur:blur(12px);
    --radius:18px;
    --shadow:0 18px 60px rgba(0,0,0,.55), inset 0 0 80px rgba(255,255,255,.04);
    --size-orb:min(62vw, 420px);
    --ease:cubic-bezier(.2,.8,.2,1);
    --glow-color: rgba(157,123,255,0.20);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--txt);
    background: radial-gradient(140% 120% at 50% 0%, #14183a 0%, #0c0f22 55%, #07080d 100%);
    -webkit-font-smoothing:antialiased; overflow:hidden;
  }

  /* ===== Indicador mini (Cena ativa) ===== */
  .scene-indicator{
    position:fixed; top:8px; left:50%; transform:translateX(-50%);
    display:flex; gap:8px; align-items:center; z-index:1200;
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.22);
    padding:6px 10px; border-radius:999px; backdrop-filter:var(--blur); -webkit-backdrop-filter:var(--blur);
    box-shadow:var(--shadow); font-size:12px; letter-spacing:.3px; opacity:.0; pointer-events:none; transition:opacity .25s var(--ease), transform .25s var(--ease);
  }
  .scene-indicator.show{ opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(0) }
  .scene-indicator .label{ color:#eaf2ff }
  .scene-indicator .reset{ appearance:none; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); color:var(--txt); padding:4px 8px; border-radius:999px; cursor:pointer; }
  .scene-indicator .reset:active{ transform:scale(.97) }

  /* ===== Toggle de tema + BG glow (KOBLLUX) ===== */
  #themeToggle{position:fixed;top:14px;left:50%;transform:translateX(-50%);width:33px;height:33px;border-radius:50%;border:2px solid rgba(255,255,255,0.18);background:transparent;display:grid;place-items:center;cursor:pointer;z-index:1199;backdrop-filter:blur(6px)}
  #themeToggle::after{content:'';width:24px;height:24px;border-radius:50%;border:1px solid rgba(255,255,255,0.06)}
  #bgGlow{position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(circle at 50% 45%, var(--glow-color) 0%, transparent 30%), radial-gradient(circle at 50% 60%, rgba(0,0,0,0.6) 40%, transparent 70%)}

  /* ===== Splash / Orbe ===== */
  .stage{position:relative; width:100%; height:100%; display:grid; place-items:center; padding:20px}
  .orb-scene{position:relative; width:min(680px,88vw); height:min(680px,88vw); display:grid; place-items:center; z-index:10}
  canvas#bgCanvas{position:absolute;inset:0;width:100%;height:100%;display:block}
  /* KOBLLUX full-screen particles */
  canvas#kx3gs{position:fixed;inset:0;width:100%;height:100%;z-index:0;pointer-events:none;display:block}
  .orb-wrap{position:relative; width:var(--size-orb); height:var(--size-orb); display:grid; place-items:center; filter:drop-shadow(0 30px 60px rgba(0,0,0,.65)); z-index:40; cursor:pointer}
  canvas#orb, canvas#particles{position:absolute; inset:0; width:100%; height:100%; border-radius:50%; display:block}
  .orb-glow{position:absolute; inset:-10%; border-radius:50%; pointer-events:none;
    background:radial-gradient(60% 60% at 50% 50%, rgba(122,60,255,.18), rgba(0,229,255,.14) 45%, rgba(0,0,0,0) 70%);
    filter:blur(18px); opacity:.95; transition:opacity .6s var(--ease), transform .6s var(--ease)}
  .orb-wrap.activated .orb-glow{ transform: scale(1.05); }
  .orbe-label{position:absolute;bottom:-42px;font-weight:700;opacity:.9;letter-spacing:.6px;color:#eaf2ff;text-shadow:0 1px 0 rgba(0,0,0,.5)}
  .call{position:absolute; bottom:26px; left:50%; transform:translateX(-50%); color:var(--muted); font-size:12px; letter-spacing:.3px; opacity:.9; white-space:nowrap; pointer-events:none; transition:opacity .35s var(--ease)}

  /* ===== Backdrop e Cards ===== */
  .backdrop{position:fixed; inset:0; background:rgba(4,6,10,.25); -webkit-backdrop-filter:blur(10px); backdrop-filter:blur(10px); display:none; z-index:9; opacity:0; transition:opacity .25s var(--ease)}
  .backdrop.active{display:block; opacity:1}
  .card{position:fixed; inset:24px 16px; border-radius:var(--radius); border:1px solid var(--ring);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    box-shadow:0 30px 80px rgba(0,0,0,.6), inset 0 0 80px rgba(255,255,255,.04);
    display:none; z-index:10; transform:translateY(12px) scale(.985); opacity:0; transition:transform .28s var(--ease), opacity .28s var(--ease); overflow:hidden}
  .card.active{display:block; transform:translateY(0) scale(1); opacity:1}
  .card.min .content{display:none}
  .card header{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px;
    border-bottom:1px solid rgba(255,255,255,.08); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0))}
  .title{display:flex; align-items:center; gap:8px}
  .dot{width:10px; height:10px; border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.25) inset}
  .ok{background:#33e08a} .warn{background:#ffd35a} .err{background:#ff6b6b} .lock{background:#8b93a6}
  .card header h3{margin:0; font-size:14px; letter-spacing:.3px}
  .act{display:flex; gap:8px}
  .iconbtn{appearance:none; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); color:var(--txt);
    padding:6px 10px; border-radius:10px; font-size:12px; display:inline-flex; align-items:center; gap:6px; cursor:pointer;
    backdrop-filter:var(--blur); -webkit-backdrop-filter:var(--blur); transition:transform .15s var(--ease), background .2s var(--ease)}
  .iconbtn:active{ transform:scale(.98) }
  .iconbtn svg{width:16px; height:16px; stroke:currentColor; fill:none}

  .content{position:absolute; inset:48px 12px 12px 12px; overflow:auto; border-radius:12px}
  .mod-section{display:grid; gap:12px; background:rgba(5,8,14,.6); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; animation: rise .35s var(--ease) both}
  .row{display:grid; gap:8px}
  label{font-size:12px; color:var(--muted)}
  input,textarea,select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.05); color:var(--txt); outline:none}

  /* ===== Loja / Estojo + HUD de Cenas ===== */
  .store-head{display:grid; gap:8px; align-items:start; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08)}
  .scene-hud{display:flex; gap:8px; overflow:auto}
  .filters{display:flex; gap:8px; overflow:auto}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); font-size:12px; color:var(--muted); display:inline-flex; gap:8px; align-items:center; white-space:nowrap; cursor:pointer; transition:transform .15s var(--ease), background .2s var(--ease)}
  .pill:active{ transform:scale(.97) }
  .pill.active{color:#eaf2ff; border-color:#8ab4ff}
  .pill.disabled{opacity:.5; pointer-events:none}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:12px}
  .tile{position:relative; border:1px solid var(--ring); border-radius:14px; padding:12px; background:rgba(255,255,255,.04); display:grid; gap:8px; transform: translateY(8px); opacity:0; animation: rise .35s var(--ease) forwards}
  .tile h4{margin:0; font-size:13px}
  .tile .mini{font-size:11px; color:var(--muted)}
  .tile .buy{justify-self:start}
  .tile.locked::after{content:"🔒"; position:absolute; top:8px; right:8px; opacity:.8}
  .tile .badge{position:absolute; top:8px; left:8px; font-size:10px; opacity:.8; padding:2px 6px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06)}

  @keyframes rise{ from{ transform:translateY(8px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
  @media(min-width:768px){ .grid{grid-template-columns:repeat(3,1fr)} }

  /* ===== Toast ===== */
  .toast{ position:fixed; top:16px; right:16px; z-index:1300; display:grid; gap:8px }
  .toast .t{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.22); color:#eaf2ff; padding:8px 12px; border-radius:12px; box-shadow:var(--shadow); transform:translateY(-6px); opacity:0; animation:toastIn .25s var(--ease) forwards }
  @keyframes toastIn{ to{ transform:translateY(0); opacity:1 } }

  /* ===== Picker de Arquétipos (KOBLLUX) ===== */
  .overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,4,8,0.6);z-index:1400}
  .overlay.show{display:grid}
  .picker{width:min(86vw,560px);height:min(86vw,560px);position:relative;display:block}
  .archNode{position:absolute;width:48px;height:48px;border-radius:12px;display:grid;place-items:center;color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.12);cursor:pointer}
  .archNode.picked{box-shadow:0 8px 22px rgba(255,255,255,.06);transform:scale(1.06)}
  .picker-controls{position:absolute;bottom:-70px;left:50%;transform:translateX(-50%);display:flex;gap:10px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02);color:#eaf2ff;cursor:pointer}
</style>

<!-- HUD v11->v12 PATCH START: CSS -->
<style>
/* ===== HUD de opções ao redor do ORB (portado da v11) ===== */
.options { position:absolute; inset:0; pointer-events:none; z-index:50; }
.opt{
  position:absolute; width:64px; height:64px; border-radius:16px;
  border:1px solid var(--ring, rgba(255,255,255,.18));
  background:var(--glass, rgba(8,14,30,.35));
  box-shadow:var(--shadow, 0 6px 20px rgba(0,0,0,.35));
  backdrop-filter:var(--blur, saturate(140%) blur(8px));
  -webkit-backdrop-filter:var(--blur, saturate(140%) blur(8px));
  display:grid; place-items:center; transition:transform .18s ease, opacity .4s ease;
  opacity:0; pointer-events:none;
}
.opt svg{ width:28px; height:28px; stroke:#deebff; stroke-width:2; fill:none; stroke-linecap:round; stroke-linejoin:round; }
.opt .lab{ position:absolute; bottom:-20px; font-size:11px; color:var(--muted, #a8b0c0); }
.options.active .opt{ opacity:1; pointer-events:auto; }
.opt:active{ transform:scale(.98); }

/* posições iguais às da v11, usando fallback para --size-orb */
.opt.fenda    { top:  calc(50% - (var(--size-orb, 220px))/2 - 18px - 64px); left: calc(50% - 64px - 18px); }
.opt.sigilo   { top:  calc(50% - (var(--size-orb, 220px))/2 - 18px - 64px); left: calc(50% + 18px); }
.opt.chaves   { top:  calc(50% + (var(--size-orb, 220px))/2 + 18px);        left: calc(50% - 64px - 18px); }
.opt.playlist { top:  calc(50% + (var(--size-orb, 220px))/2 + 18px);        left: calc(50% + 18px); }

@media (min-width:768px){
  .opt{ width:72px; height:72px; }
  .opt svg{ width:30px; height:30px; }
  .opt.fenda    { top:  calc(50% - (var(--size-orb, 220px))/2 - 22px - 72px); left: calc(50% - 72px - 22px); }
  .opt.sigilo   { top:  calc(50% - (var(--size-orb, 220px))/2 - 22px - 72px); left: calc(50% + 22px); }
  .opt.chaves   { top:  calc(50% + (var(--size-orb, 220px))/2 + 22px);        left: calc(50% - 72px - 22px); }
  .opt.playlist { top:  calc(50% + (var(--size-orb, 220px))/2 + 22px);        left: calc(50% + 22px); }
}
</style>
<!-- HUD v11->v12 PATCH END: CSS -->


<!-- HUD v12 REMOVAL START: CSS -->
<style>
  /* Remover HUD de Cenas das versões mais novas */
  .scene-hud { display: none !important; }
</style>
<!-- HUD v12 REMOVAL END: CSS -->

</head>
<body>
<div class="scene-indicator" id="sceneIndicator" aria-live="polite">
  <span class="label" id="sceneLabel">Cena: —</span>
  <button class="reset" id="sceneReset" title="Reset cena">Reset</button>
</div>

<button id="themeToggle" aria-label="Trocar tema" title="Trocar tema"></button>
<div id="bgGlow"></div>

<div class="stage">
  <div class="orb-scene" id="scene" role="application" aria-label="Campo Nebula">
    <canvas id="bgCanvas" aria-hidden="true"></canvas>
    <canvas id="kx3gs" aria-hidden="true"></canvas>
    <div class="orb-wrap" id="orbWrap" aria-label="Orbe Nebula" tabindex="0">
<!-- HUD v11->v12 PATCH START: HTML -->
<div class="options" id="hudOptions">
  <button class="opt fenda" data-open="fenda" aria-label="Abrir Fenda">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 2l8 4-8 4-8-4 8-4Z"/><path d="M4 6v8l8 4 8-4V6"/><path d="M12 10v8"/>
    </svg>
    <div class="lab">Fenda</div>
  </button>
  <button class="opt sigilo" data-open="sigilo" aria-label="Abrir Sigilo">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 3v18"/><path d="M5 9h14"/><path d="M7 15h10"/><path d="M6 6l3 3-3 3"/><path d="M18 6l-3 3 3 3"/>
    </svg>
    <div class="lab">Sigilo</div>
  </button>
  <button class="opt chaves" data-open="chaves" aria-label="Abrir Chaves">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <circle cx="7" cy="7" r="3"/><path d="M9 9l8 8"/><path d="M14 14l3 3l2-2l-3-3"/>
    </svg>
    <div class="lab">Chaves</div>
  </button>
  <button class="opt playlist" data-open="player" aria-label="Abrir Player">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M4 6h12"/><path d="M4 10h12"/><path d="M4 14h8"/><circle cx="18" cy="16" r="3"/>
    </svg>
    <div class="lab">Playlist</div>
  </button>
</div>
<!-- HUD v11->v12 PATCH END: HTML -->

      <canvas id="orb"></canvas>
      <div class="orb-glow" id="orbGlow"></div>
      <canvas id="particles"></canvas>
      <div class="orbe-label">KOBLLUX</div>
    </div>
  </div>
  <div class="call" id="call">Toque o orbe para ativar · “Sempre único, sempre seu”.</div>
</div>

<!-- Backdrop / Cards -->
<div class="backdrop" id="backdrop"></div>

<section class="card" id="card">
  <header>
    <div class="title"><span class="dot lock" id="statusDot"></span><h3 id="cardTitle">Módulo</h3></div>
    <div class="act">
      <button class="iconbtn" id="btnRefresh" title="Atualizar" aria-label="Atualizar">
        <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 2.64-6.36M3 3v6h6"/></svg><span>refresh</span>
      </button>
      <button class="iconbtn" id="btnMin" title="Minimizar" aria-label="Minimizar">
        <svg viewBox="0 0 24 24"><path d="M6 12h12"/></svg><span>caret</span>
      </button>
    </div>
  </header>
  <div class="content" id="cardContent"></div>
</section>

<section class="card" id="store">
  <div class="store-head">
    <div class="scene-hud" id="sceneHud" aria-label="Cenas">
      <button class="pill" data-scene="foco">Cena: Foco</button>
      <button class="pill" data-scene="criacao">Cena: Criação</button>
      <button class="pill" data-scene="analise">Cena: Análise</button>
    </div>
    <div class="filters" id="filters"></div>
  </div>
  <div class="content">
    <div class="grid" id="grid"></div>
  </div>
</section>

<div class="toast" id="toast"></div>

<!-- Picker de Arquétipos -->
<div class="overlay" id="pickerOverlay" aria-hidden="true">
  <div class="picker" id="archPicker" role="dialog" aria-label="Escolha Arquétipos"></div>
  <div class="picker-controls">
    <button class="btn" id="saveAct">Salvar Ativação</button>
    <button class="btn" id="closePicker">Fechar</button>
  </div>
</div>

<script>
/* ==========================================================================
   STATE curto + Activation + AutoBoot
   ========================================================================== */
const LS_KEY = 'dual.state';
const LS_ACT = 'dual.activation';
const AUTOBOOT = true;
const DefaultState = {
  layout: { order: ['orb','store','modules'] },
  inventory: { modules: { bau:false, rede:false, chaves:false, editor:false, logs:false, sigilo:false, player:false, layouts:false } },
  keys: { openrouter: '' },
  profile: { avatarSigil: '' },
  scene: { active: '' }
};
let State = loadState();
function loadState(){ try{ const raw = localStorage.getItem(LS_KEY); if(raw){ return Object.assign({}, DefaultState, JSON.parse(raw)); } }catch(e){} return JSON.parse(JSON.stringify(DefaultState)); }
function saveState(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(State)); }catch(e){} }
function setModule(id, v){ State.inventory.modules[id]=!!v; saveState(); }
function has(id){ return !!State.inventory.modules[id]; }

/* ==========================================================================
   Theming (KOBLLUX) — 4 temas
   ========================================================================== */
(function theme(){
  const themeToggle = document.getElementById('themeToggle');
  const bgGlow = document.getElementById('bgGlow');
  const themes = [
    {name:'medium-dark', a:'#7a6bff', b:'#00c5e5', bg:'#0b0c10'},
    {name:'medium-light', a:'#ff52e5', b:'#7ec8ff', bg:'#0f1720'},
    {name:'dark', a:'#5b2cff', b:'#00a8b5', bg:'#050507'},
    {name:'light', a:'#ffd2f0', b:'#8be7ff', bg:'#f6f7fb'}
  ];
  let idx = 0;
  function hexToRgba(hex,a){ a = (typeof a === 'number') ? a : 1; if(hex[0]!=='#') return hex; let v = hex.slice(1); if(v.length===3) v = v.split('').map(x=>x+x).join(''); const n=parseInt(v,16); const r=(n>>16)&255, g=(n>>8)&255, b=n&255; return `rgba(${r},${g},${b},${a})`; }
  function apply(i){ const t = themes[i%themes.length]; document.documentElement.style.setProperty('--nebA', t.a); document.documentElement.style.setProperty('--nebB', t.b); document.body.style.background = t.bg; bgGlow.style.background = `radial-gradient(circle at 50% 45%, ${hexToRgba(t.a,0.18)} 0%, transparent 30%), radial-gradient(circle at 50% 60%, rgba(0,0,0,0.6) 40%, transparent 70%)`; }
  themeToggle.addEventListener('click', ()=>{ idx=(idx+1)%themes.length; apply(idx); });
  apply(0);
})();

/* ==========================================================================
   ORB shader (WebGL) + Partículas 2D (v12)
   ========================================================================== */
(function orbGL(){
  const canvas = document.getElementById('orb');
  const gl = canvas.getContext('webgl', { antialias:true, alpha:true });
  if(!gl) return;
  const dpr = Math.min(2, window.devicePixelRatio||1);
  function resize(){ const r = canvas.getBoundingClientRect(); canvas.width = Math.floor(r.width*dpr); canvas.height = Math.floor(r.height*dpr); gl.viewport(0,0,canvas.width,canvas.height); }
  new ResizeObserver(resize).observe(canvas); resize();
  const vs = `attribute vec2 aPos; varying vec2 vUv; void main(){ vUv=aPos*0.5+0.5; gl_Position=vec4(aPos,0.,1.);} `;
  const fs = `precision highp float; varying vec2 vUv; uniform vec2 u_res; uniform float u_time; uniform float u_active;
  float hash(vec2 p){ return fract(sin(dot(p, vec2(127.1,311.7))) * 43758.5453123); }
  float noise(vec2 p){ vec2 i=floor(p); vec2 f=fract(p); float a=hash(i);
    float b=hash(i+vec2(1.,0.)); float c=hash(i+vec2(0.,1.)); float d=hash(i+vec2(1.,1.));
    vec2 u=f*f*(3.-2.*f); return mix(a,b,u.x)+(c-a)*u.y*(1.-u.x)+(d-b)*u.x*u.y; }
  vec3 cam(){ return vec3(0.,0.,3.); }
  vec3 getRay(vec2 uv){ uv=(uv*2.-1.); uv.x*=u_res.x/u_res.y; return normalize(vec3(uv,-1.8)); }
  bool isph(vec3 ro, vec3 rd, float r, out float t){
    float b=dot(ro,rd); float c=dot(ro,ro)-r*r; float h=b*b-c; if(h<0.){t=-1.;return false;}
    h=sqrt(h); t=-b-h; if(t<0.) t=-b+h; if(t<0.) return false; return true; }
  void main(){
    vec2 uv=vUv; vec3 ro=cam(); vec3 rd=getRay(uv);
    float t; vec3 col=vec3(0.02,0.03,0.07); vec3 fogCol=vec3(0.07,0.09,0.16);
    float g=noise(uv*6.+u_time*0.05)*0.25; col+=vec3(0.25,0.08,0.55)*g*0.6+vec3(0.0,0.35,0.55)*g*0.4;
    if(isph(ro,rd,1.,t)){
      vec3 p=ro+rd*t; vec3 n=normalize(p);
      float bands=0.5+0.5*sin(6.*p.x+5.*p.y+u_time*0.6);
      float swirl=noise(p.xy*4.+u_time*0.2);
      vec3 A=vec3(0.52,0.24,1.00), B=vec3(0.00,0.90,1.00);
      vec3 base=mix(A,B, clamp(bands*0.6+swirl*0.4,0.,1.));
      vec3 L=normalize(vec3(0.6,0.7,0.5));
      float diff=max(dot(n,L),0.); float rim=pow(1.-max(dot(n,-rd),0.), 2.);
      float pulse=0.5+0.5*sin(u_time*1.5); float act=mix(0.6,1.0,u_active);
      vec3 c=base*(0.35+0.75*diff*act)+(B*0.6+A*0.4)*rim*(0.6+0.4*pulse);
      float fogAmt=1.0-exp(-t*0.35); col=mix(c,fogCol,fogAmt*0.25);
    }else{
      vec2 centered=uv-0.5; centered.x*=u_res.x/u_res.y;
      float d=length(centered); float outer=smoothstep(0.58,0.12,d);
      vec3 halo=vec3(0.25,0.12,0.55)*outer*0.35+vec3(0.00,0.55,0.95)*outer*0.25;
      col+=halo;
    }
    float vign=smoothstep(1.2,0.55, length((uv-0.5)*vec2(u_res.x/u_res.y,1.)));
    col*=vign; gl_FragColor=vec4(col,0.98);
  }`;
  function sh(type,src){ const s=gl.createShader(type); gl.shaderSource(s,src); gl.compileShader(s); return s; }
  const pr=gl.createProgram(); gl.attachShader(pr,sh(gl.VERTEX_SHADER,vs)); gl.attachShader(pr,sh(gl.FRAGMENT_SHADER,fs)); gl.linkProgram(pr); gl.useProgram(pr);
  const buf=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,buf); gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1, 1,-1,1,1,-1,1]),gl.STATIC_DRAW);
  const loc=gl.getAttribLocation(pr,'aPos'); gl.enableVertexAttribArray(loc); gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);
  const uRes=gl.getUniformLocation(pr,'u_res'); const uTime=gl.getUniformLocation(pr,'u_time'); const uActive=gl.getUniformLocation(pr,'u_active');
  let start=performance.now(), active=0.0;
  function draw(){ const t=(performance.now()-start)*0.001; gl.uniform2f(uRes,canvas.width,canvas.height); gl.uniform1f(uTime,t); gl.uniform1f(uActive,active); gl.drawArrays(gl.TRIANGLES,0,6); requestAnimationFrame(draw) }
  draw();
  window.__orbGL__ = { setActive:(v)=>{ active=v?1.0:0.0; }, pulse:()=>{ let k=0,steps=24; const id=setInterval(()=>{ active=Math.min(1,active+0.06); if(++k>=steps) clearInterval(id);},16); setTimeout(()=>{ let j=0; const id2=setInterval(()=>{ active=Math.max(0,active-0.06); if(++j>=steps) clearInterval(id2);},16);},380); } };
})();

(function particles2D(){
  const c=document.getElementById('particles'),ctx=c.getContext('2d'); const dpr=Math.min(2,window.devicePixelRatio||1);
  function rs(){ const r=c.getBoundingClientRect(); c.width=Math.floor(r.width*dpr); c.height=Math.floor(r.height*dpr); }
  new ResizeObserver(rs).observe(c); rs();
  const N=90, nodes=Array.from({length:N},()=>({a:Math.random()*6.283, r:0.42+Math.random()*0.48, s:(0.2+Math.random()*0.7)*(Math.random()<0.5?-1:1), z:0.5+Math.random()*0.5, hue:200+Math.random()*160}));
  function draw(t){ ctx.clearRect(0,0,c.width,c.height); ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.translate(c.width/2,c.height/2); const scale=Math.min(c.width,c.height)/2;
    for(const n of nodes){ const ang=n.a + t*0.0002*n.s; const rr=n.r*(0.65+0.15*Math.sin(t*0.001+n.a)); const x=Math.cos(ang)*rr*scale; const y=Math.sin(ang)*rr*scale*0.98;
      const rad=(1.2+n.z*1.8)*(c.width/800); const g=ctx.createRadialGradient(x,y,0,x,y,rad*4);
      g.addColorStop(0,`hsla(${n.hue},85%,70%,.85)`); g.addColorStop(1,`hsla(${n.hue},85%,50%,0)`); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,rad,0,Math.PI*2); ctx.fill(); }
    ctx.restore(); requestAnimationFrame(draw) }
  requestAnimationFrame(draw);
})();

/* ==========================================================================
   KOBLLUX ThreeGS background (full-screen particles) + OrbitCenter
   ========================================================================== */
(function KOBLLUX_BG(){
  const CAN = document.getElementById('kx3gs'); if(!CAN) return;
  const DPR = Math.min(2, window.devicePixelRatio||1);
  let gl=null, program=null, buf=null, rafId=null, running=false;
  let uTime=null, uRes=null, uHue=null, uAlpha=null, uCenter=null;
  function resize(){ const w=Math.max(1,Math.floor(CAN.clientWidth*DPR)), h=Math.max(1,Math.floor(CAN.clientHeight*DPR)); if(CAN.width!==w||CAN.height!==h){ CAN.width=w; CAN.height=h; if(gl&&uRes) gl.uniform2f(uRes,w,h);} }
  function sh(t,s){ const o=gl.createShader(t); gl.shaderSource(o,s); gl.compileShader(o); return o; }
  function createGL(){
    gl = CAN.getContext('webgl',{alpha:true,antialias:true,premultipliedAlpha:false}); if(!gl) return;
    const vs = 'attribute float aId; uniform vec2 uRes; uniform float uTime; varying float vId; void main(){ float id=aId; vId=id; float r1=fract(sin(id*17.0)*43758.5453); float r2=fract(sin(id*113.0)*43758.5453); float ang=uTime*(0.2+r2*1.2)+r1*6.28318; float layer=mix(0.4,1.0,fract(r1)); float radius=0.15+r1*0.85; float x=radius*cos(ang)*layer; float y=radius*sin(ang)*layer*0.58; float px=(x*0.9+0.5)*uRes.x; float py=(y*0.9+0.5)*uRes.y; vec2 ndc=vec2(px/uRes.x*2.0-1.0, py/uRes.y*2.0-1.0); gl_PointSize=mix(1.5,3.8,layer); gl_Position=vec4(ndc,0.0,1.0); }';
    const fs = 'precision mediump float; uniform float uHue; uniform float uAlpha; uniform vec2 uCenter; uniform vec2 uRes; varying float vId; vec3 hsl2rgb(float h,float s,float l){ float c=(1.0-abs(2.0*l-1.0))*s; float x=c*(1.0-abs(mod(h*6.0,2.0)-1.0)); float m=l-0.5*c; vec3 rgb; if(h<1.0/6.0) rgb=vec3(c,x,0.0); else if(h<2.0/6.0) rgb=vec3(x,c,0.0); else if(h<3.0/6.0) rgb=vec3(0.0,c,x); else if(h<4.0/6.0) rgb=vec3(0.0,x,c); else if(h<5.0/6.0) rgb=vec3(x,0.0,c); else rgb=vec3(c,0.0,x); return rgb+m; } void main(){ vec2 p=gl_PointCoord*2.0-1.0; float d=dot(p,p); float a=exp(-3.0*d); vec3 col=hsl2rgb(uHue,1.0,0.55); vec2 frag=vec2(gl_FragCoord.x,gl_FragCoord.y); float dist=distance(frag,uCenter); float maxd=length(uRes); float glowFactor=1.0 - smoothstep(0.0,maxd*0.9,dist); float alpha=a*uAlpha*(0.45+0.55*glowFactor); gl_FragColor=vec4(col,alpha); }';
    program = gl.createProgram(); gl.attachShader(program,sh(gl.VERTEX_SHADER,vs)); gl.attachShader(program,sh(gl.FRAGMENT_SHADER,fs)); gl.linkProgram(program); gl.useProgram(program);
    uTime=gl.getUniformLocation(program,'uTime'); uRes=gl.getUniformLocation(program,'uRes'); uHue=gl.getUniformLocation(program,'uHue'); uAlpha=gl.getUniformLocation(program,'uAlpha'); uCenter=gl.getUniformLocation(program,'uCenter');
    const N=700; const ids=new Float32Array(N); for(let i=0;i<N;i++) ids[i]=i+1;
    buf=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,buf); gl.bufferData(gl.ARRAY_BUFFER,ids,gl.STATIC_DRAW);
    const loc=gl.getAttribLocation(program,'aId'); gl.enableVertexAttribArray(loc); gl.vertexAttribPointer(loc,1,gl.FLOAT,false,0,0);
    gl.enable(gl.BLEND); gl.blendFunc(gl.SRC_ALPHA, gl.ONE); gl.disable(gl.DEPTH_TEST);
    resize(); gl.uniform2f(uRes,CAN.width,CAN.height); gl.uniform1f(uAlpha,0.9); gl.uniform1f(uHue,0.55);
  }
  let pendingCenter=[window.innerWidth/2,window.innerHeight/2];
  function tick(ts){ if(!running) return; const t=ts*0.001; if(gl&&program){ gl.useProgram(program); gl.clearColor(0,0,0,0); gl.clear(gl.COLOR_BUFFER_BIT); gl.uniform1f(uTime,t); if(uCenter) gl.uniform2f(uCenter,pendingCenter[0],pendingCenter[1]); gl.drawArrays(gl.POINTS,0,700);} rafId=requestAnimationFrame(tick); }
  function start(){ if(running) return; running=true; resize(); if(!gl) createGL(); rafId=requestAnimationFrame(tick); }
  function stop(){ running=false; if(rafId) cancelAnimationFrame(rafId); rafId=null; }
  function setCenter(x,y){ pendingCenter=[x,y]; if(gl&&uCenter) gl.uniform2f(uCenter,x,y); }
  function setHue(h){ if(!gl||!uHue) return; const H=(((h%360)+360)%360)/360; gl.uniform1f(uHue,H); }
  window.addEventListener('resize', resize, {passive:true});
  // center based on orb position
  function updateCenter(){ const orb=document.getElementById('orbWrap'); if(!orb) return; const r=orb.getBoundingClientRect(); const cx=r.left+r.width/2; const cy=r.top+r.height/2; setCenter(cx,cy); }
  setTimeout(updateCenter,200); window.addEventListener('resize', ()=>setTimeout(updateCenter,100), {passive:true});
  // prime on first interaction
  ['pointerdown','touchstart'].forEach(ev=> document.body.addEventListener(ev, ()=>start(), {once:true, passive:true}));
  // expose (optional)
  window.__KOBLLUX_BG__ = { start, stop, setCenter, setHue };
})();

/* ==========================================================================
   BG Canvas fallback (dots glow) — opcional junto ao ThreeGS
   ========================================================================== */
(function bgCanvas(){
  const canvas = document.getElementById('bgCanvas');
  const DPR = Math.min(2, window.devicePixelRatio || 1);
  function setup(){
    canvas.width = Math.floor(canvas.clientWidth * DPR) || 300;
    canvas.height = Math.floor(canvas.clientHeight * DPR) || 300;
    const ctx = canvas.getContext('2d'); const parts=[];
    for(let i=0;i<160;i++){ parts.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height, r:1+Math.random()*3, a:0.06+Math.random()*0.9}); }
    (function loop(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.globalCompositeOperation='lighter'; for(const p of parts){ p.x += (Math.random()-0.5)*2; p.y += (Math.random()-0.5)*2; const g=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*8); g.addColorStop(0, 'hsla(210,90%,60%,'+p.a+')'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); } requestAnimationFrame(loop); })();
  }
  function onResize(){ canvas.style.width='100%'; canvas.style.height='100%'; const needW=Math.floor(canvas.clientWidth*DPR)||300; const needH=Math.floor(canvas.clientHeight*DPR)||300; if(canvas.width!==needW||canvas.height!==needH) setup(); }
  window.addEventListener('resize', onResize, {passive:true}); setTimeout(onResize, 150);
})();

/* ==========================================================================
   Picker de Arquétipos (long-press no Orbe) — salva hue/áudio
   ========================================================================== */
(function picker(){
  const overlay = document.getElementById('pickerOverlay');
  const archPicker = document.getElementById('archPicker');
  const saveAct = document.getElementById('saveAct');
  const closePicker = document.getElementById('closePicker');
  const orb = document.getElementById('orbWrap');
  const bgGlow = document.getElementById('bgGlow');

  const ARCH = [
    {key:'cuidador',label:'Cuidador',hue:185,color:'#39FFB6',freq:432},
    {key:'criador',label:'Criador',hue:145,color:'#5CFF6A',freq:528},
    {key:'heroi',label:'Herói',hue:20,color:'#FF6B6B',freq:396},
    {key:'prestativo',label:'Prestativo',hue:40,color:'#FFC857',freq:639},
    {key:'mago',label:'Mago',hue:210,color:'#7EC8FF',freq:741},
    {key:'explorador',label:'Explorador',hue:195,color:'#64E3FF',freq:852},
    {key:'rebelde',label:'Rebelde',hue:350,color:'#FF5C8A',freq:285},
    {key:'inocente',label:'Inocente',hue:320,color:'#F3C1FF',freq:963},
    {key:'amante',label:'Amante',hue:330,color:'#FF71CF',freq:528},
    {key:'orfao',label:'Órfão',hue:0,color:'#A0A7B3',freq:417},
    {key:'transformador',label:'Transformador',hue:190,color:'#00C5E5',freq:741},
    {key:'sabio',label:'Sábio',hue:265,color:'#9D7BFF',freq:888}
  ];

  let picked = new Set();
  function hexToRgba(hex,a){ a = (typeof a === 'number') ? a : 1; if(hex[0]!=='#') return hex; let v = hex.slice(1); if(v.length===3) v = v.split('').map(x=>x+x).join(''); const n=parseInt(v,16); const r=(n>>16)&255, g=(n>>8)&255, b=n&255; return `rgba(${r},${g},${b},${a})`; }

  function buildPicker(){
    archPicker.innerHTML='';
    const R = Math.min(archPicker.clientWidth, archPicker.clientHeight)/2 - 60;
    const cx = archPicker.clientWidth/2; const cy = archPicker.clientHeight/2;
    for(let i=0;i<ARCH.length;i++){
      const a = ARCH[i]; const ang = (i/ARCH.length)*Math.PI*2 - Math.PI/2;
      const x = Math.round(cx + R*Math.cos(ang)); const y = Math.round(cy + R*Math.sin(ang));
      const n = document.createElement('div'); n.className='archNode'; n.style.left=(x-24)+'px'; n.style.top=(y-24)+'px';
      n.style.background = a.color; n.textContent = a.label[0].toUpperCase(); n.title=a.label; n.dataset.key=a.key; n.dataset.hue=a.hue;
      n.addEventListener('click', ()=>{
        if(picked.has(a.key)){ picked.delete(a.key); n.classList.remove('picked'); }
        else{
          if(picked.size>=2){ const first = picked.values().next().value; picked.delete(first); const prev = archPicker.querySelector('[data-key=\"'+first+'\"]'); if(prev) prev.classList.remove('picked'); }
          picked.add(a.key); n.classList.add('picked');
        }
      });
      archPicker.appendChild(n);
    }
  }

  // WebAudio simples
  let audioCtx=null; const AC = window.AudioContext || window.webkitAudioContext;
  function ensureAudio(){ if(!audioCtx){ try{ audioCtx = new AC(); }catch(e){ audioCtx = null; } } }
  function tone(freq, dur){ try{ ensureAudio(); if(!audioCtx) return; const t0=audioCtx.currentTime; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.0001,t0); g.gain.linearRampToValueAtTime(0.6,t0+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t0+dur); o.start(t0); o.stop(t0+dur+0.02);}catch(e){} }

  function saveActivation(){
    if(picked.size===0){ alert('Selecione 1 ou 2 arquétipos'); return; }
    const arr = Array.from(picked);
    const A = ARCH.find(x=>x.key===arr[0]); const B = arr[1]?ARCH.find(x=>x.key===arr[1]):null;
    const hue = A ? A.hue : 210;
    const act = {t: Date.now(), a1: A?.key||null, a2: B?.key||null, hue: hue, name: B? (A.label+' + '+B.label):A.label};
    try{ localStorage.setItem(LS_ACT, JSON.stringify(act)); }catch(e){}
    overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true');
    if (A) { tone(A.freq,0.8); if(B){ setTimeout(()=>tone(B.freq,0.8), 260); } }
    document.documentElement.style.setProperty('--glow-color', hexToRgba(A.color,0.22));
  }

  let pressTimer=null;
  function startPress(){ pressTimer=setTimeout(()=>{ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); buildPicker(); }, 600); }
  function endPress(){ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } }
  orb.addEventListener('pointerdown', startPress); orb.addEventListener('pointerup', endPress); orb.addEventListener('pointerleave', endPress);

  document.getElementById('saveAct').addEventListener('click', saveActivation);
  document.getElementById('closePicker').addEventListener('click', ()=>{ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); });

  try{ const act = JSON.parse(localStorage.getItem(LS_ACT)||'null'); if(act){ document.documentElement.style.setProperty('--glow-color', `hsla(${act.hue},90%,60%,0.22)`); } }catch(e){}
})();

/* ==========================================================================
   UI FLOW: Orbe → Loja (Baú primeiro) → Estojo → Módulos + Cenas + AutoBoot
   ========================================================================== */
(function uiFlow(){
  const orbWrap = document.getElementById('orbWrap');
  const call = document.getElementById('call');
  const backdrop = document.getElementById('backdrop');
  const store = document.getElementById('store');
  const grid = document.getElementById('grid');
  const filters = document.getElementById('filters');
  const sceneHud = document.getElementById('sceneHud');
  const sceneIndicator = document.getElementById('sceneIndicator');
  const sceneLabel = document.getElementById('sceneLabel');
  const sceneReset = document.getElementById('sceneReset');
  const toastEl = document.getElementById('toast');

  const card = document.getElementById('card');
  const cardTitle = document.getElementById('cardTitle');
  const cardContent = document.getElementById('cardContent');
  const statusDot = document.getElementById('statusDot');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnMin = document.getElementById('btnMin');

  const CATS = ['Ferramentas','Mídia','Chaves','Símbolos','Layouts'];
  const MODULES = [
    {id:'bau',      name:'Baú (LS)', cat:'Ferramentas', mini:'Salvar base local',  requires:[],  storeOnly:true},
    {id:'rede',     name:'Rede & Ping', cat:'Ferramentas', mini:'Status / Dots',   requires:['bau']},
    {id:'chaves',   name:'Chaves SK', cat:'Chaves', mini:'OpenRouter local',      requires:['bau']},
    {id:'editor',   name:'Editor HTML', cat:'Ferramentas', mini:'Inline',          requires:['bau']},
    {id:'logs',     name:'Logs', cat:'Ferramentas', mini:'Eventos e capturas',    requires:['bau']},
    {id:'sigilo',   name:'Símbolo / Sigilo', cat:'Símbolos', mini:'Avatar / selo', requires:['bau']},
    {id:'player',   name:'Player', cat:'Mídia', mini:'2 faixas locais',           requires:['bau']},
    {id:'layouts',  name:'Layouts', cat:'Layouts', mini:'Ordem / Workspace',      requires:['bau']},
  ];

  function toast(msg){ const t=document.createElement('div'); t.className='t'; t.textContent=msg; toastEl.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(-6px)'; setTimeout(()=>t.remove(),300); }, 1800); }

  /* ===== Ações globais ===== */
  btnRefresh.onclick = ()=>{ const id = card.getAttribute('data-id'); if (id==='rede'){ updateRedeStatus(true); toast('Rede atualizada'); } else if (id==='logs'){ renderLogs(cardContent, true); toast('Logs atualizados'); } else { openModule(id); toast('Atualizado'); } };
  btnMin.onclick = ()=> card.classList.toggle('min');
  function setStatus(s){ statusDot.className='dot '+s; }

  /* ===== Store helpers ===== */
  function animateGrid(){ [...grid.children].forEach((tile,i)=> tile.style.animationDelay = (i*0.035)+'s'); }
  function selectFilter(cat){ [...filters.children].forEach(x=>x.classList.remove('active')); const idx = CATS.indexOf(cat); if (idx>=0 && filters.children[idx]) filters.children[idx].classList.add('active'); }
  function renderFilters(){
    filters.innerHTML=''; const noBau = !has('bau');
    for (const c of CATS){
      const p = document.createElement('button');
      p.className='pill' + (noBau && c!=='Ferramentas' ? ' disabled' : ''); p.textContent=c;
      p.onclick = ()=>{ if (p.classList.contains('disabled')){ toast('Compre o Baú para liberar'); return; } selectFilter(c); filterList(c); };
      filters.appendChild(p);
    }
    filters.firstChild.classList.add('active');
  }
  function filterList(cat){
    grid.innerHTML='';
    const isFirst = !has('bau');
    const items = MODULES.filter(m=> m.cat===cat && (isFirst ? (m.id==='bau') : true));
    for (const m of items){
      const locked = !m.requires.every(r=> has(r));
      const installed = has(m.id);
      const tile = document.createElement('div');
      tile.className = 'tile' + (locked && m.id!=='bau' ? ' locked':'');
      tile.innerHTML = `<span class="badge">${m.cat}</span><h4>${m.name}</h4><div class="mini">${m.mini}</div>`;
      const btn = document.createElement('button');
      btn.className='iconbtn buy';
      if (m.id==='bau' && !installed){
        btn.innerHTML = 'Comprar Baú';
        btn.onclick = ()=>{ setModule('bau', true); renderFilters(); filterList('Ferramentas'); call.textContent = 'Baú adquirido · Abra e instale seus módulos'; if (window.__orbGL__) window.__orbGL__.pulse(); toast('Baú instalado'); updateIndicator(); };
      } else if (!installed){
        btn.textContent = locked ? 'Bloqueado' : 'Instalar';
        btn.disabled = locked;
        btn.onclick = ()=>{ setModule(m.id, true); filterList(cat); if (window.__orbGL__) window.__orbGL__.pulse(); toast(m.name+' instalado'); };
      } else {
        btn.textContent = 'Abrir';
        btn.onclick = ()=> openModule(m.id);
      }
      grid.appendChild(tile);
      tile.appendChild(btn);
    }
    animateGrid();
  }
  function openStore(cat='Ferramentas'){ backdrop.classList.add('active'); store.classList.add('active'); renderFilters(); selectFilter(cat); filterList(cat); }
  function closeStore(){ store.classList.remove('active'); if (!card.classList.contains('active')) backdrop.classList.remove('active'); }
  function closeCard(){ card.classList.remove('active'); if (!store.classList.contains('active')) backdrop.classList.remove('active'); }

  /* ===== Módulos ===== */
  function openModule(id){
    const mod = MODULES.find(m=>m.id===id);
    if (mod && !mod.requires.every(r=> has(r))){ toast('Requer Baú (LS)'); openStore('Ferramentas'); return; }
    card.setAttribute('data-id', id);
    cardTitle.textContent = mod?.name || 'Módulo';
    cardContent.innerHTML = '';
    setStatus('ok');
    backdrop.classList.add('active'); card.classList.add('active');
    if (id==='rede') renderRede(cardContent);
    if (id==='chaves') renderChaves(cardContent);
    if (id==='editor') renderEditor(cardContent);
    if (id==='logs') renderLogs(cardContent);
    if (id==='sigilo') renderSigilo(cardContent);
    if (id==='player') renderPlayer(cardContent);
    if (id==='layouts') renderLayouts(cardContent);
  }
  let redeTimer=null;
  function renderRede(root){ const dot = document.createElement('div'); dot.className='pill'; dot.textContent=' status: '; const d = document.createElement('span'); d.className='dot ok'; d.style.marginLeft='8px'; dot.appendChild(d); const info = document.createElement('div'); info.className='mini'; info.textContent='Dots: atualiza a cada ~2s'; root.appendChild(el('div',{class:'mod-section'}, dot, info)); updateRedeStatus(); if (redeTimer) clearInterval(redeTimer); redeTimer = setInterval(updateRedeStatus, 2000); }
  function updateRedeStatus(forcePulse=false){ const online = navigator.onLine; setStatus(online?'ok':'err'); if (forcePulse && window.__orbGL__) window.__orbGL__.pulse(); }
  function renderChaves(root){ const avatar = document.createElement('div'); avatar.style.cssText='width:36px;height:36px;border-radius:50%;border:1px solid var(--ring);display:inline-grid;place-items:center;background:rgba(255,255,255,.05);'; avatar.textContent = State.profile.avatarSigil ? '⟡' : '◌'; const head = el('div',{class:'pill'}, avatar, txt(' Chave OpenRouter local')); const inp = el('input',{type:'password',placeholder:'Cole sua chave OpenRouter…', value: State.keys.openrouter||''}); const save = el('button',{class:'iconbtn',onclick:()=>{ State.keys.openrouter=inp.value||''; saveState(); setStatus(State.keys.openrouter?'ok':'warn'); toast('Chave salva'); }}, icon('save'), txt('Salvar')); const clear= el('button',{class:'iconbtn',onclick:()=>{ State.keys.openrouter=''; inp.value=''; saveState(); setStatus('warn'); toast('Chave removida'); }}, icon('trash'), txt('Limpar')); root.appendChild(el('div',{class:'mod-section'}, head, el('div',{class:'row'}, el('label',null,txt('OpenRouter Key')), inp), el('div',{class:'row'}, save, clear))); setStatus(State.keys.openrouter?'ok':'warn'); }
  function renderEditor(root){ const area=el('textarea',{rows:10,placeholder:'Cole/edite HTML aqui…'}); const hint=el('div',{class:'pill'}, icon('code'), txt(' Editor inline — salva no Baú (LS) em dual.editor.html')); const save=el('button',{class:'iconbtn',onclick:()=>{ try{ localStorage.setItem('dual.editor.html', area.value||''); setStatus('ok'); toast('HTML salvo no Baú'); }catch(e){ setStatus('err'); toast('Falha ao salvar'); } }}, icon('save'), txt('Salvar')); root.appendChild(el('div',{class:'mod-section'}, hint, area, save)); }
  function renderLogs(root,onlyRefresh=false){ const box=el('div',{class:'mod-section'}); const list=el('div',{class:'row'}); const push=(msg)=>{ const it=el('div',{class:'pill'}, icon('dot'), txt(' '+new Date().toLocaleTimeString()+': '+msg)); list.prepend(it); }; if (!onlyRefresh){ const btn=el('button',{class:'iconbtn',onclick:()=>push('evento manual')}, icon('bolt'), txt('Logar evento')); box.appendChild(btn); box.appendChild(el('div',{class:'mini'}, txt('Captura básica; estenda para console/erros quando quiser.'))); } box.appendChild(list); root.appendChild(box); }
  function renderSigilo(root){ const pre=el('pre',{style:'margin:0;font-size:12px;line-height:1.2;white-space:pre-wrap;'}); const gen=el('button',{class:'iconbtn',onclick:()=>{ pre.textContent = makeSigil(); State.profile.avatarSigil=pre.textContent; saveState(); setStatus('ok'); toast('Sigilo gerado'); }}, icon('spark'), txt('Gerar Sigilo')); const set=el('button',{class:'iconbtn',onclick:()=>{ State.profile.avatarSigil=pre.textContent||'⟡'; saveState(); setStatus('ok'); toast('Avatar definido'); }}, icon('check'), txt('Definir Avatar')); pre.textContent = State.profile.avatarSigil || '⟡'; root.appendChild(el('div',{class:'mod-section'}, el('div',{class:'pill'}, icon('sigil'), txt(' Símbolo / Sigilo — avatar')) , pre, el('div',{class:'row'}, gen, set))); }
  function makeSigil(){ const runes=['ᚠ','ᚢ','ᚦ','ᚨ','ᚱ','ᚲ','ᚷ','ᚹ','ᚺ','ᚾ','ᛁ','ᛃ','✶','⟡','☼','✦']; let s=''; for(let i=0;i<25;i++){ s+=(i%5===0?'\n':' ')+runes[Math.floor(Math.random()*runes.length)]; } return s.trim(); }
  function renderPlayer(root){ const slot=(i)=>{ const inp=el('input',{type:'file',accept:'audio/*'}); const a=el('audio',{controls:true,style:'width:100%'}); inp.onchange=()=>{ const f=inp.files&&inp.files[0]; if(f){ a.src=URL.createObjectURL(f); a.play().catch(()=>{}); setStatus('ok'); toast('Faixa '+i+' carregada'); } }; return el('div',{class:'mod-section'}, el('label',null,txt('Faixa '+i)), inp, a); }; root.appendChild(el('div',{class:'mod-section'}, el('div',{class:'pill'}, icon('music'), txt(' Player — 2 faixas locais')) )); root.appendChild(slot(1)); root.appendChild(slot(2)); }
  function renderLayouts(root){ const order=el('input',{value: (Array.isArray(State.layout.order)? State.layout.order.join(', '): State.layout.order||'') }); const save=el('button',{class:'iconbtn',onclick:()=>{ const v=order.value.trim(); State.layout.order = v || ['orb','store','modules']; saveState(); setStatus('ok'); updateIndicator(); toast('layout.order salvo'); }}, icon('save'), txt('Salvar ordem')); const exec=el('button',{class:'iconbtn',onclick:()=>{ const v=(order.value||'').trim(); if (v) execCustomScene(v); }}, icon('spark'), txt('Executar Cena')); const exp =el('button',{class:'iconbtn',onclick:()=>{ const data=JSON.stringify(State,null,2); const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(data); a.download='dual_base_export.json'; a.click(); toast('Base exportada'); }}, icon('export'), txt('Exportar Base')); const tip=el('div',{class:'row'}, el('div',{class:'mod-section'}, txt('Ex.: "Foco+Sigilo" | "Criação+Editor" | "Análise+Logs"'))); root.appendChild(el('div',{class:'mod-section'}, el('div',{class:'pill'}, icon('grid'), txt(' Layout.order + Export Base')), el('div',{class:'row'}, el('label',null,txt('layout.order (CSV ou label de cena)')), order), el('div',{class:'row'}, save, exec, exp), tip)); }

  /* ===== Scenes ===== */
  const SceneDefs = { foco:{ name:'Foco', target:'chaves', cat:'Chaves' }, criacao:{ name:'Criação', target:'editor', cat:'Ferramentas' }, analise:{ name:'Análise', target:'logs', cat:'Ferramentas' } };
  sceneHud.addEventListener('click', (e)=>{ const btn = e.target.closest('[data-scene]'); if(!btn) return; applyScene(btn.getAttribute('data-scene')); });
  function applyScene(key){
    const sc = SceneDefs[key]; if(!sc) return;
    State.scene.active = key; State.layout.order = ['orb','modules','store']; saveState();
    [...sceneHud.children].forEach(x=>x.classList.remove('active')); const activeBtn = sceneHud.querySelector(`[data-scene="${key}"]`); if (activeBtn) activeBtn.classList.add('active');
    updateIndicator();
    if (!has('bau')){ toast('Cena requer Baú (LS)'); openStore('Ferramentas'); return; }
    if (has(sc.target)){ openModule(sc.target); toast('Cena: '+sc.name); } else { openStore(sc.cat); toast('Instale '+sc.name+' · '+(sc.target.toUpperCase())); }
  }

  /* ===== Indicador mini ===== */
  function updateIndicator(){
    let label = '';
    if (State.scene.active){ const key = State.scene.active; const name = (SceneDefs[key]?.name)||key; label = 'Cena: '+name; }
    else if (typeof State.layout.order === 'string' && State.layout.order.trim()){ label = 'Cena: '+State.layout.order; }
    if (label){ sceneLabel.textContent = label; sceneIndicator.classList.add('show'); } else { sceneIndicator.classList.remove('show'); }
  }
  updateIndicator();
  sceneReset.addEventListener('click', ()=>{
    State.scene.active = '';
    State.layout.order = ['orb','store','modules'];
    saveState(); updateIndicator();
    closeCard(); closeStore();
    toast('Cena resetada');
  });

  /* ===== Cena custom ===== */
  const TOKEN_TO_MODULE = { foco:'chaves', criacao:'editor', 'criação':'editor', analise:'logs', 'análise':'logs', rede:'rede', sigilo:'sigilo', chaves:'chaves', editor:'editor', logs:'logs', player:'player', layouts:'layouts' };
  const TOKEN_TO_CAT = { chaves:'Chaves', sigilo:'Símbolos', editor:'Ferramentas', logs:'Ferramentas', rede:'Ferramentas', player:'Mídia', layouts:'Layouts' };
  function execCustomScene(sceneStr){
    if (!sceneStr) return;
    if (!has('bau')){ toast('Cena requer Baú (LS)'); openStore('Ferramentas'); return; }
    const tokens = sceneStr.split('+').map(s=>s.trim().toLowerCase()).filter(Boolean);
    const primaryMod = TOKEN_TO_MODULE[tokens[0]];
    if (primaryMod){ if (has(primaryMod)) openModule(primaryMod); else openStore(TOKEN_TO_CAT[primaryMod]||'Ferramentas'); }
    State.scene.active = ''; saveState(); updateIndicator(); toast('Cena custom: '+sceneStr);
  }

  /* ===== Auto-Boot no primeiro toque do Orbe ===== */
  orbWrap.addEventListener('click', ()=>{
    call.textContent='Ativado · Loja / Estojo';
    orbWrap.classList.add('activated');
    if (window.__orbGL__) window.__orbGL__.pulse();

    if (AUTOBOOT){
      if (typeof State.layout.order === 'string' && State.layout.order.trim()){ execCustomScene(State.layout.order.trim()); return; }
      if (State.scene.active){ applyScene(State.scene.active); return; }
    }
    openStore('Ferramentas');
  }, { once:true });

  /* ===== Backdrop ===== */
  backdrop.addEventListener('click', ()=>{
    if (card.classList.contains('active')) { closeCard(); return; }
    if (store.classList.contains('active')) { closeStore(); return; }
  });

  /* helpers DOM */
  function el(tag, attrs, ...children){ const n=document.createElement(tag); if(attrs) for(const k in attrs){ if(k==='style') n.setAttribute('style',attrs[k]); else if(k==='class') n.className=attrs[k]; else if(k.startsWith('on')) n[k]=attrs[k]; else n.setAttribute(k,attrs[k]); } children.forEach(c=> n.appendChild(typeof c==='string'? document.createTextNode(c): c)); return n; }
  function txt(t){ return document.createTextNode(t); }
  function icon(name){ const ns='http://www.w3.org/2000/svg'; const s=document.createElementNS(ns,'svg'); s.setAttribute('viewBox','0 0 24 24'); const P=(d)=>{const p=document.createElementNS(ns,'path'); p.setAttribute('d',d); p.setAttribute('fill','none'); p.setAttribute('stroke','currentColor'); p.setAttribute('stroke-linecap','round'); p.setAttribute('stroke-linejoin','round'); p.setAttribute('stroke-width','2'); return p;};
    if(name==='save'){ s.append(P('M5 4h14v16H5z')); s.append(P('M8 4v5h8V4')); }
    if(name==='trash'){ s.append(P('M4 7h16')); s.append(P('M6 7l1 13h10l1-13')); s.append(P('M9 7V4h6v3')); }
    if(name==='sigil'){ s.append(P('M12 3v18')); s.append(P('M5 9h14')); s.append(P('M7 15h10')); s.append(P('M6 6l3 3-3 3')); s.append(P('M18 6l-3 3 3 3')); }
    if(name==='music'){ s.append(P('M9 18a3 3 0 1 0 0-6 3 3 0 0 0 0 6z')); s.append(P('M12 6v8')); s.append(P('M12 6l7-2v8')); }
    if(name==='check'){ s.append(P('M4 12l5 5L20 6')); }
    if(name==='code'){ s.append(P('M8 6l-4 6 4 6')); s.append(P('M16 6l4 6-4 6')); }
    if(name==='bolt'){ s.append(P('M13 2L3 14h7l-1 8 10-12h-7l1-8z')); }
    if(name==='dot'){ s.append(P('M12 12h.01')); }
    if(name==='export'){ s.append(P('M12 16V4')); s.append(P('M8 8l4-4 4 4')); s.append(P('M4 20h16')); }
    if(name==='grid'){ s.append(P('M4 4h7v7H4z')); s.append(P('M13 4h7v7h-7z')); s.append(P('M4 13h7v7H4z')); s.append(P('M13 13h7v7h-7z')); }
    if(name==='spark'){ s.append(P('M12 2l1.8 4.5L18 8l-4.2 1.4L12 14l-1.8-4.6L6 8l4.2-1.5L12 2z')); }
    return s;
  }
})(); // uiFlow
</script>

<!-- HUD v11->v12 PATCH START: JS -->
<script>
/* ===== HUD v11 → v12: ativação e roteamento ===== */
(function hudV11toV12(){
  try {
    const orbWrap = document.getElementById('orbWrap') || document.querySelector('.orb-wrap');
    const hud     = document.getElementById('hudOptions');
    const call    = document.getElementById('call');
    if(!orbWrap || !hud) return;

    // mostra HUD no 1º toque, preservando Auto-Boot/Loja/Cenas das v12
    orbWrap.addEventListener('click', ()=>{
      hud.classList.add('active');
      try{ if (window.__orbGL__ && typeof window.__orbGL__.pulse === 'function') window.__orbGL__.pulse(); }catch(e){}
      if (call) call.textContent = 'Ativado · HUD + Loja/Cenas';
    }, { once:true });

    // abrir módulos usando a própria openModule(id) das v12 (se existir)
    document.addEventListener('click', (ev)=>{
      const t = ev.target;
      const btn = t && t.closest ? t.closest('.opt[data-open]') : null;
      if(!btn) return;
      const id = btn.getAttribute('data-open');
      try {
        if (typeof openModule === 'function') {
          openModule(id);
        } else if (window && window.ui && typeof window.ui.openModule === 'function') {
          window.ui.openModule(id);
        }
      } catch(e){}
    }, true);
  } catch(e) {}
})();
</script>
<!-- HUD v11->v12 PATCH END: JS -->


<!-- HUD v11 ONLY START: JS (intercept) -->
<script>
(function interceptAutoBootToHUD(){
  try{
    const orbWrap = document.getElementById('orbWrap') || document.querySelector('.orb-wrap');
    const hud = document.getElementById('hudOptions') || document.getElementById('options');
    const call = document.getElementById('call');
    if(!orbWrap || !hud) return;
    // Captura o 1º clique no ORB antes dos handlers da v12
    const handler = function(ev){
      try{
        ev.stopImmediatePropagation();
        ev.stopPropagation();
        ev.preventDefault();
      }catch(e){}
      // Mostra somente o HUD da v11
      hud.classList.add('active');
      if (call) call.textContent = 'Ativado · HUD (Fenda · Sigilo · Chaves · Playlist)';
      try{ if (window.__orbGL__ && typeof window.__orbGL__.pulse === 'function') window.__orbGL__.pulse(); }catch(e){}
      // remove a si mesmo para não interferir depois
      orbWrap.removeEventListener('click', handler, true);
    };
    orbWrap.addEventListener('click', handler, { once: true, capture: true });
  }catch(e){}
})();
</script>
<!-- HUD v11 ONLY END: JS (intercept) -->


<!-- HUD v11 ONLY START: JS (alias) -->
<script>
(function ensurePlaylistAlias(){
  try{
    window.addEventListener('click', function(ev){
      const btn = ev.target && ev.target.closest ? ev.target.closest('.opt[data-open]') : null;
      if(!btn) return;
      const raw = btn.getAttribute('data-open');
      const map = { 'playlist':'player' };
      const id = map[raw] || raw;
      if (raw !== id) btn.setAttribute('data-open', id);
    }, true);
  }catch(e){}
})();
</script>
<!-- HUD v11 ONLY END: JS (alias) -->


<!-- HUD v11 ONLY START: JS (fenda render) -->
<script>
(function v11FendaRender(){
  try{
    function openFenda(){
      var card = document.getElementById('card');
      var cardTitle = document.getElementById('cardTitle');
      var cardContent = document.getElementById('cardContent');
      var backdrop = document.getElementById('backdrop');
      if(!card || !cardTitle || !cardContent || !backdrop) return;
      card.setAttribute('data-id', 'fenda');
      cardTitle.textContent = 'Fenda';
      cardContent.innerHTML = ''
        + '<div class="mod-section">'
        + '  <div class="pill">'
        + '    <svg viewBox="0 0 24 24" aria-hidden="true" style="width:16px;height:16px;stroke:currentColor;fill:none;vertical-align:-3px;margin-right:6px">'
        + '      <path d="M3 3h8v8H3z"/><path d="M13 3h8v8h-8z"/><path d="M13 13h8v8h-8z"/><path d="M3 13h8v8H3z"/>'
        + '    </svg>'
        + '    Fenda Nebula — abertura de espaços simbólicos'
        + '  </div>'
        + '  <div class="row">'
        + '    <label>Ritual de abertura</label>'
        + '    <textarea rows="4" placeholder="Descreva a intenção da Fenda…"></textarea>'
        + '  </div>'
        + '  <div class="row">'
        + '    <button class="btn" id="btnPulse">'
        + '      <svg viewBox="0 0 24 24" aria-hidden="true" style="width:16px;height:16px;stroke:currentColor;fill:none;vertical-align:-3px;margin-right:6px">'
        + '        <path d="M12 2l1.8 4.5L18 8l-4.2 1.4L12 14l-1.8-4.6L6 8l4.2-1.5L12 2z"/>'
        + '      </svg>'
        + '      Pulsar Orbe'
        + '    </button>'
        + '  </div>'
        + '</div>';
      var btn = document.getElementById('btnPulse');
      if (btn){
        btn.addEventListener('click', function(){
          try{ if (window.__orbGL__ && typeof window.__orbGL__.pulse === 'function') window.__orbGL__.pulse(); }catch(e){}
        });
      }
      backdrop.classList.add('active');
      card.classList.add('active');
    }

    // Interceptar especificamente o clique na Fenda
    document.addEventListener('click', function(ev){
      var btn = ev.target && ev.target.closest ? ev.target.closest('.opt.fenda[data-open]') : null;
      if(!btn) return;
      try{ ev.stopImmediatePropagation(); ev.stopPropagation(); ev.preventDefault(); }catch(e){}
      openFenda();
    }, true);

    // Expor em window caso precise
    window.openFenda = openFenda;
  }catch(e){}
})();
</script>
<!-- HUD v11 ONLY END: JS (fenda render) -->
</body>
</html>
